<div class="gtranslate-footer-credit">
    <a href="https://gtranslate.io" target="_blank" rel="nofollow" class="gt-badge">
        <span class="gt-text">{{ lang('TOPIC_TRANSLATE_POWERED') }} </span>
        <span style="margin-left: 5px; font-weight: bold; font-size: 14px; text-decoration: none;">
            <span class="gt-g">G</span><span class="gt-o1">o</span><span class="gt-o2">o</span><span class="gt-g">g</span><span class="gt-l">l</span><span class="gt-e">e</span>
            <span style="color: #676767;">Translate</span>
        </span>
    </a>
</div>

<script>
(function () {
    "use strict";

    // 1. CACHE E CONFIGURAÇÕES
    const ORIGINAL_POST_HTML = new Map();
    
    window.gtranslateSettings = {
        "default_language": "{{ GTRANSLATE_DEFAULT_LANGUAGE|default('auto') }}",
        "native_language_names": {{ GTRANSLATE_NATIVE_NAMES ? 'true' : 'false' }},
        "detect_browser_language": {{ GTRANSLATE_DETECT_BROWSER ? 'true' : 'false' }},
        "languages": {{ GTRANSLATE_LANGUAGES_JSON|raw|default('["en"]') }},
    "wrapper_selector": ".gtranslate_wrapper",
    "flag_size": 16,
    "switcher_horizontal_position": "inline",
    "switcher_text_color": "#f7f7f7",
    "switcher_arrow_color": "#f2f2f2",
    "switcher_border_color": "#161616",
    "switcher_background_color": "#303030",
    "switcher_background_shadow_color": "#474747",
    "switcher_background_hover_color": "#3a3a3a",
    "dropdown_text_color": "#eaeaea",
    "dropdown_hover_color": "#748393",
    "dropdown_background_color": "#474747"
    };

    const dLang = window.gtranslateSettings.default_language;

    // 2. FUNÇÕES DE SUPORTE
    function limparCookies() {
        const d = window.location.hostname;
        const cookies = ["googtrans", "googtrans_ext"];
        const domains = [d, "." + d, "." + d.split('.').slice(-2).join('.')];
        
        cookies.forEach(c => {
            domains.forEach(dom => {
                document.cookie = c + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=" + dom + ";";
            });
            document.cookie = c + "=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";
        });
    }

    function salvarOriginal(el) {
        if (el && el.id && !ORIGINAL_POST_HTML.has(el.id)) {
            ORIGINAL_POST_HTML.set(el.id, el.innerHTML);
        }
    }

    function restaurarTudo() {
        document.querySelectorAll('.post-content-area, .post-body, .post-content').forEach(el => {
            if (ORIGINAL_POST_HTML.has(el.id)) {
                el.innerHTML = ORIGINAL_POST_HTML.get(el.id);
            }
            el.classList.add('notranslate');
            el.setAttribute('translate', 'no');
        });
    }

    // 3. FUNÇÕES GLOBAIS
    window.resetarTradutor = function() {
        limparCookies();
        restaurarTudo();
        // Força o seletor do GTranslate a voltar para o topo
        const sel = document.querySelector("select.gt_selector");
        if (sel) sel.value = dLang + "|" + dLang;
        
        // Em casos críticos de "vazamento", o reload ainda é o mais seguro
        location.reload();
    };

    window.abrirTradutor = function(btn) {
        // Fecha outros menus e garante que o HTML original está salvo
        document.querySelectorAll(".gtranslate_wrapper").forEach(w => w.style.display = "none");
        
        const wrapper = btn.parentNode.querySelector(".gtranslate_wrapper");
        const postArea = btn.closest(".postbody")?.querySelector(".post-content-area, .post-body, .post-content");

        if (postArea) {
            salvarOriginal(postArea);
            // Antes de traduzir este, garante que os outros voltaram ao original
            // para evitar que o cookie do Google traduza a página toda
            restaurarTudo(); 

            postArea.classList.remove("notranslate");
            postArea.setAttribute('translate', 'yes');
        }

        if (wrapper) {
            wrapper.style.display = "block";
            const sel = wrapper.querySelector("select");
            if (sel) {
                sel.onchange = function() {
                    const lang = this.value.split('|')[1];
                    if (lang === dLang || lang === 'auto') {
                        window.resetarTradutor();
                    }
                    setTimeout(() => { wrapper.style.display = "none"; }, 400);
                };
            }
        }
    };

    // 4. INICIALIZAÇÃO E EVENTOS
    document.addEventListener("DOMContentLoaded", () => {
        // Salva o estado original de todos os posts assim que a página carrega
        document.querySelectorAll('.post-content-area, .post-body, .post-content').forEach(salvarOriginal);

        // Adiciona label
        document.querySelectorAll(".gtranslate_wrapper").forEach(w => {
            if (!w.querySelector(".gt_label_translate")) {
                const label = document.createElement("div");
                label.className = "gt_label_translate gt-box";
                label.textContent = "{L_TRANSLATE}";
                w.prepend(label);
            }
        });

        // Fechar ao clicar fora
        document.addEventListener("click", (e) => {
            if (!e.target.closest(".gtranslate_wrapper") && !e.target.closest(".btn-translate-custom")) {
                document.querySelectorAll(".gtranslate_wrapper").forEach(w => w.style.display = "none");
            }
        });
    });
})();
</script>
<script src="https://cdn.gtranslate.net/widgets/latest/dwf.js" defer></script>